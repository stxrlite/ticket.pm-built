{"version":3,"file":"close.js","sourceRoot":"/","sources":["utils/close.ts"],"names":[],"mappings":"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","sourcesContent":["import { generateMessages } from \"ticket-bot-transcript-uploader\";\nimport zlib from \"zlib\";\nimport axios from \"axios\";\nimport { ActionRowBuilder, ButtonBuilder, ButtonInteraction, ButtonStyle, Collection, ColorResolvable, CommandInteraction, ComponentType, EmbedBuilder, GuildMember, Message, ModalSubmitInteraction, TextChannel } from \"discord.js\";\nimport { log } from \"./logs\";\nimport {ExtendedClient} from \"../structure\";\nlet domain = \"https://ticket.pm/\";\n\n/*\nCopyright 2023 Sayrix (github.com/Sayrix)\n\nLicensed under the Creative Commons Attribution 4.0 International\nplease check https://creativecommons.org/licenses/by/4.0 for more informations.\n*/\n\ntype ticketType = {\n    id: number;\n    channelid: string;\n    messageid: string;\n    category: string;\n    invited: string;\n    reason: string;\n    creator: string;\n    createdat: bigint;\n    claimedby: string | null;\n    claimedat: bigint | null;\n    closedby: string | null;\n    closedat: bigint | null;\n    closereason: string | null;\n    transcript: string | null;\n}\n\nexport async function close(interaction: ButtonInteraction | CommandInteraction | ModalSubmitInteraction, client: ExtendedClient, reason?: string) {\n\tif (!client.config.closeOption.createTranscript) domain = client.locales.getSubValue(\"other\",\"unavailable\");\n\n\tconst ticket = await client.prisma.tickets.findUnique({\n\t\twhere: {\n\t\t\tchannelid: interaction.channel?.id\n\t\t}\n\t});\n\tconst ticketClosed = ticket?.closedat && ticket.closedby;\n\tif (!ticket) return interaction.editReply({ content: \"Ticket not found\" }).catch((e) => console.log(e));\n\n\tif (\n\t\tclient.config.closeOption.whoCanCloseTicket === \"STAFFONLY\" &&\n\t\t!(interaction.member as GuildMember | null)?.roles.cache.some((r) => client.config.rolesWhoHaveAccessToTheTickets.includes(r.id))\n\t)\n\t\treturn interaction\n\t\t\t.editReply({\n\t\t\t\tcontent: client.locales.getValue(\"ticketOnlyClosableByStaff\")\n\t\t\t})\n\t\t\t.catch((e) => console.log(e));\n\n\tif (ticketClosed)\n\t\treturn interaction\n\t\t\t.editReply({\n\t\t\t\tcontent: client.locales.getValue(\"ticketAlreadyClosed\")\n\t\t\t})\n\t\t\t.catch((e) => console.log(e));\n\n\tlog(\n\t\t{\n\t\t\tLogType: \"ticketClose\",\n\t\t\tuser: interaction.user,\n\t\t\tticketId: ticket.id,\n\t\t\tticketChannelId: interaction.channel?.id,\n\t\t\tticketCreatedAt: ticket.createdat,\n\t\t\treason: reason\n\t\t},\n\t\tclient\n\t);\n\t\n\t// Normally the user that closes the ticket will get posted here, but we'll do it when the ticket finalizes\n\n\tconst creator = ticket.creator;\n\tconst invited = JSON.parse(ticket.invited) as string[];\n\n\t(interaction.channel as TextChannel | null)?.permissionOverwrites\n\t\t.edit(creator, {\n\t\t\tViewChannel: false\n\t\t})\n\t\t.catch((e: unknown) => console.log(e));\n\tinvited.forEach(async (user) => {\n\t\t(interaction.channel as TextChannel | null)?.permissionOverwrites\n\t\t\t.edit(user, {\n\t\t\t\tViewChannel: false\n\t\t\t})\n\t\t\t.catch((e) => console.log(e));\n\t});\n\n\tinteraction\n\t\t.editReply({\n\t\t\tcontent: client.locales.getValue(\"ticketCreatingTranscript\")\n\t\t})\n\t\t.catch((e) => console.log(e));\n\tasync function _close(id: string, ticket: ticketType) {\n\t\tif (client.config.closeOption.closeTicketCategoryId) (interaction.channel as TextChannel | null)?.setParent(client.config.closeOption.closeTicketCategoryId).catch((e) => console.log(e));\n\n\t\tconst msg = await interaction.channel?.messages.fetch(ticket.messageid);\n\t\tconst embed = new EmbedBuilder(msg?.embeds[0].data);\n\n\t\tconst rowAction = new ActionRowBuilder<ButtonBuilder>();\n\t\tmsg?.components[0]?.components?.map((x) => {\n\t\t\tif(x.type !== ComponentType.Button) return;\n\t\t\tconst builder = new ButtonBuilder(x.data);\n\t\t\tif (x.customId === \"close\") builder.setDisabled(true);\n\t\t\tif (x.customId === \"close_askReason\") builder.setDisabled(true);\n\t\t\trowAction.addComponents(builder);\n\t\t});\n\n\t\tmsg?.edit({\n\t\t\tcontent: msg.content,\n\t\t\tembeds: [embed],\n\t\t\tcomponents: [rowAction]\n\t\t})\n\t\t\t.catch((e) => console.log(e));\n\n\t\tinteraction.channel?.send({\n\t\t\tcontent: client.locales.getValue(\"ticketTranscriptCreated\").replace(\n\t\t\t\t\"TRANSCRIPTURL\",\n\t\t\t\tdomain === client.locales.getSubValue(\"other\", \"unavailable\") ? client.locales.getSubValue(\"other\", \"unavailable\") : `<${domain}${id}>`\n\t\t\t)\n\t\t}).catch((e) => console.log(e));\n\t\t\n\t\tticket = await client.prisma.tickets.update({\n\t\t\tdata: {\n\t\t\t\tclosedby: interaction.user.id,\n\t\t\t\tclosedat: Date.now(),\n\t\t\t\tclosereason: reason,\n\t\t\t\ttranscript: domain === client.locales.getSubValue(\"other\", \"unavailable\") ? client.locales.getSubValue(\"other\", \"unavailable\") : `${domain}${id}`\n\t\t\t},\n\t\t\twhere: {\n\t\t\t\tchannelid: interaction.channel?.id\n\t\t\t}\n\t\t});\n\n\t\tconst row = new ActionRowBuilder<ButtonBuilder>().addComponents(\n\t\t\tnew ButtonBuilder().setCustomId(\"deleteTicket\").setLabel(client.locales.getSubValue(\"other\", \"deleteTicketButtonMSG\")).setStyle(ButtonStyle.Danger)\n\t\t);\n\t\tconst locale = client.locales;\n\t\tinteraction.channel?.send({\n\t\t\tembeds: [\n\t\t\t\tJSON.parse(\n\t\t\t\t\tJSON.stringify(locale.getSubRawValue(\"embeds\", \"ticketClosed\"))\n\t\t\t\t\t\t.replace(\"TICKETCOUNT\", ticket.id.toString())\n\t\t\t\t\t\t.replace(\"REASON\", (ticket.closereason ?? client.locales.getSubValue(\"other\", \"noReasonGiven\")).replace(/[\\n\\r]/g, \"\\\\n\"))\n\t\t\t\t\t\t.replace(\"CLOSERNAME\", interaction.user.tag)\n\t\t\t\t)\n\t\t\t],\n\t\t\tcomponents: [row]\n\t\t})\n\t\t\t.catch((e) => console.log(e));\n\n\n\t\tif(!client.config.closeOption.dmUser) return;\n\t\tconst footer = locale.getSubValue(\"embeds\", \"ticketClosedDM\", \"footer\", \"text\").replace(\"ticket.pm\", \"\");\n\t\tconst ticketClosedDMEmbed = new EmbedBuilder({\n\t\t\tcolor: 0,\n\t\t})\n\t\t\t.setColor(locale.getNoErrorSubValue(\"embeds\", \"ticketClosedDM\", \"color\") as ColorResolvable ?? client.config.mainColor)\n\t\t\t.setDescription(\n\t\t\t\tclient.locales.getSubValue(\"embeds\", \"ticketClosedDM\", \"description\")\n\t\t\t\t\t.replace(\"TICKETCOUNT\", ticket.id.toString())\n\t\t\t\t\t.replace(\"TRANSCRIPTURL\", `${domain}${id}`)\n\t\t\t\t\t.replace(\"REASON\", ticket.closereason ?? client.locales.getSubValue(\"other\", \"noReasonGiven\"))\n\t\t\t\t\t.replace(\"CLOSERNAME\", interaction.user.tag)\n\t\t\t)\n\t\t\t.setFooter({\n\t\t\t\t// Please respect the project by keeping the credits, (if it is too disturbing you can credit me in the \"about me\" of the bot discord)\n\t\t\t\ttext: `ticket.pm ${footer.trim() !== \"\" ? `- ${footer}` : \"\"}`, // Please respect the LICENSE :D\n\t\t\t\t// Please respect the project by keeping the credits, (if it is too disturbing you can credit me in the \"about me\" of the bot discord)\n\t\t\t\ticonURL: locale.getNoErrorSubValue(\"embeds\", \"ticketClosedDM\", \"footer\", \"iconUrl\")\n\t\t\t});\n\n\t\tclient.users.fetch(creator).then((user) => {\n\t\t\tuser\n\t\t\t\t.send({\n\t\t\t\t\tembeds: [ticketClosedDMEmbed]\n\t\t\t\t})\n\t\t\t\t.catch((e) => console.log(e));\n\t\t});\n\t}\n\n\tif (!client.config.closeOption.createTranscript) {\n\t\t_close(\"\", ticket);\n\t\treturn;\n\t}\n\n\tasync function fetchAll() {\n\t\tconst collArray: Collection<string, Message<true | false>>[] = [];\n\t\tlet lastID = (interaction.channel as TextChannel | null)?.lastMessageId;\n\t\t// eslint-disable-next-line no-constant-condition\n\t\twhile (true) {\n\t\t\t// using if statement for this check causes a TypeScript bug. Hard to reproduce; thus, bug report won't be accepted.\n\t\t\tif(!lastID) break;\n\t\t\tconst fetched = await interaction.channel?.messages.fetch({ limit: 100, before: lastID });\n\t\t\tif (fetched?.size === 0) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif(fetched)\n\t\t\t\tcollArray.push(fetched);\n\t\t\tlastID = fetched?.last()?.id;\n\t\t\tif (fetched?.size !== 100) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tconst messages = collArray[0].concat(...collArray.slice(1));\n\t\treturn messages;\n\t}\n\n\tconst messages = await fetchAll();\n\tconst premiumKey = \"\";\n\n\tconst messagesJSON = await generateMessages(messages, premiumKey, \"https://m.ticket.pm\");\n\tzlib.gzip(JSON.stringify(messagesJSON), async (err, compressed) => {\n\t\tif (err) {\n\t\t\tconsole.error(err);\n\t\t} else {\n\t\t\tconst ts = await axios\n\t\t\t\t.post(`${domain}upload?key=${premiumKey}&uuid=${client.config.uuidType}`, JSON.stringify(compressed), {\n\t\t\t\t\theaders: {\n\t\t\t\t\t\t\"Content-Type\": \"application/json\"\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.catch(console.error);\n\t\t\t_close(ts?.data, ticket);\n\t\t}\n\t});\n}\n\n/*\nCopyright 2023 Sayrix (github.com/Sayrix)\n\nLicensed under the Creative Commons Attribution 4.0 International\nplease check https://creativecommons.org/licenses/by/4.0 for more informations.\n*/\n"]}